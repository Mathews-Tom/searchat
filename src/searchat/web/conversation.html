<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <title>Searchat - Conversation</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Preload fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..700;1,9..40,300..700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/base.css">

    <style>
        body {
            font-family: var(--font-sans);
            font-size: 16px;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
            background: hsl(var(--bg-base));
            color: hsl(var(--text-primary));
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
        }

        .back-button {
            font-family: var(--font-sans);
            padding: 10px 20px;
            background: hsl(var(--accent));
            color: hsl(var(--text-inverse));
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 24px;
            border-radius: var(--radius-md);
            transition: background-color var(--transition-fast);
        }

        .back-button:hover {
            background: hsl(var(--accent-hover));
        }

        .header {
            background: hsl(var(--bg-glass));
            backdrop-filter: blur(var(--blur-glass)) saturate(1.3);
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid hsl(var(--border-glass));
            border-left: 3px solid hsl(var(--accent));
            border-radius: var(--radius-md);
        }

        .header h2 {
            font-family: var(--font-sans);
            color: hsl(var(--text-primary));
            margin: 0 0 12px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .header div {
            color: hsl(var(--text-tertiary));
            font-size: 14px;
        }

        .message {
            background: hsl(var(--bg-glass));
            backdrop-filter: blur(var(--blur-glass)) saturate(1.3);
            border: 1px solid hsl(var(--border-glass));
            border-left: 3px solid transparent;
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
        }

        .message.user {
            border-left-color: hsl(var(--success));
        }

        .message.assistant {
            border-left-color: hsl(var(--accent));
        }

        .role {
            font-family: var(--font-sans);
            font-weight: 600;
            color: hsl(var(--text-tertiary));
            margin-bottom: 12px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .content {
            white-space: pre-wrap;
            font-family: var(--font-sans);
            color: hsl(var(--text-primary));
            font-size: 16px;
            line-height: 1.6;
        }

        /* Theme Switcher */
        .theme-switcher {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            padding: 3px;
            border-radius: 10px;
            background: hsl(var(--bg-surface));
            gap: 2px;
            z-index: 100;
        }

        .theme-switcher-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 26px;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            color: hsl(var(--text-tertiary));
        }

        .theme-switcher-btn.active {
            background: hsl(var(--bg-glass-active));
            color: hsl(var(--accent));
            box-shadow: var(--shadow-sm);
        }

        /* Tool badges */
        .tool-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: var(--radius-pill);
            font-size: 12px;
            font-weight: 600;
            font-family: var(--font-sans);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .tool-badge.claude {
            background: hsl(var(--accent) / 0.15);
            color: hsl(var(--accent));
        }

        .tool-badge.vibe {
            background: hsl(var(--warning) / 0.15);
            color: hsl(var(--warning));
        }

        /* Resume button */
        .resume-btn {
            font-family: var(--font-sans);
            margin-top: 12px;
            padding: 8px 16px;
            background: hsl(var(--success));
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .resume-btn:hover:not(:disabled) {
            filter: brightness(1.1);
        }

        .resume-btn:disabled {
            opacity: 0.7;
            cursor: wait;
        }

        .resume-btn.success {
            background: hsl(var(--accent));
        }

        .resume-btn.error {
            background: hsl(var(--danger));
        }

        /* Action buttons container */
        .header-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .download-btn {
            font-family: var(--font-sans);
            padding: 8px 14px;
            background: hsl(var(--accent));
            color: hsl(var(--text-inverse));
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .download-btn:hover {
            background: hsl(var(--accent-hover));
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: hsl(var(--text-tertiary));
        }
    </style>
</head>
<body>
    <!-- Theme Switcher -->
    <div class="theme-switcher" id="themeSwitcher">
        <button class="theme-switcher-btn" data-theme-mode="light" title="Light" onclick="setThemeMode('light')">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="8" cy="8" r="3"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.05 3.05l1.41 1.41M11.54 11.54l1.41 1.41M3.05 12.95l1.41-1.41M11.54 4.46l1.41-1.41"/></svg>
        </button>
        <button class="theme-switcher-btn" data-theme-mode="dark" title="Dark" onclick="setThemeMode('dark')">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 8.5a5.5 5.5 0 1 1-7-7 4.5 4.5 0 0 0 7 7z"/></svg>
        </button>
        <button class="theme-switcher-btn" data-theme-mode="auto" title="Auto" onclick="setThemeMode('auto')">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="2" width="14" height="10" rx="1.5"/><path d="M5 15h6M8 12v3"/></svg>
        </button>
    </div>

    <a href="/" class="back-button">Back to Search</a>
    <div id="conversation"><div class="loading">Loading conversation...</div></div>

    <script>
        // Theme Management (3-way: light/dark/auto)
        const themes = {
            light: {
                "--bg-base": "240 20% 97%",
                "--bg-elevated": "0 0% 100%",
                "--bg-glass": "0 0% 100% / 0.55",
                "--bg-glass-hover": "0 0% 100% / 0.72",
                "--bg-glass-active": "0 0% 100% / 0.85",
                "--bg-surface": "220 14% 96%",
                "--bg-surface-hover": "220 14% 93%",
                "--bg-overlay": "220 20% 96% / 0.8",
                "--border-glass": "0 0% 100% / 0.6",
                "--border-subtle": "220 13% 91%",
                "--border-focus": "221 83% 53%",
                "--text-primary": "220 14% 10%",
                "--text-secondary": "220 9% 43%",
                "--text-tertiary": "220 9% 60%",
                "--text-inverse": "0 0% 100%",
                "--accent": "221 83% 53%",
                "--accent-hover": "221 83% 47%",
                "--accent-subtle": "221 83% 53% / 0.08",
                "--accent-glow": "221 83% 53% / 0.15",
                "--success": "142 71% 45%",
                "--warning": "38 92% 50%",
                "--danger": "0 72% 51%",
                "--danger-subtle": "0 72% 51% / 0.08",
                "--shadow-sm": "0 1px 2px hsl(220 14% 10% / 0.04), 0 1px 3px hsl(220 14% 10% / 0.03)",
                "--shadow-md": "0 4px 6px hsl(220 14% 10% / 0.04), 0 2px 4px hsl(220 14% 10% / 0.03)",
                "--shadow-lg": "0 10px 25px hsl(220 14% 10% / 0.06), 0 4px 10px hsl(220 14% 10% / 0.04)",
                "--shadow-glass": "0 8px 32px hsl(220 14% 10% / 0.06), inset 0 1px 0 hsl(0 0% 100% / 0.6)",
                "--blur-glass": "20px",
                "--blur-bg": "40px",
                "--noise-opacity": "0.015",
                "--scrollbar-track": "220 14% 96%",
                "--scrollbar-thumb": "220 9% 82%",
                "--code-bg": "220 14% 96%"
            },
            dark: {
                "--bg-base": "224 25% 8%",
                "--bg-elevated": "224 22% 12%",
                "--bg-glass": "224 22% 14% / 0.6",
                "--bg-glass-hover": "224 22% 16% / 0.72",
                "--bg-glass-active": "224 22% 18% / 0.85",
                "--bg-surface": "224 20% 14%",
                "--bg-surface-hover": "224 20% 18%",
                "--bg-overlay": "224 25% 8% / 0.85",
                "--border-glass": "224 15% 22% / 0.6",
                "--border-subtle": "224 15% 20%",
                "--border-focus": "217 91% 60%",
                "--text-primary": "220 14% 95%",
                "--text-secondary": "220 9% 65%",
                "--text-tertiary": "220 9% 46%",
                "--text-inverse": "220 14% 10%",
                "--accent": "217 91% 60%",
                "--accent-hover": "217 91% 67%",
                "--accent-subtle": "217 91% 60% / 0.1",
                "--accent-glow": "217 91% 60% / 0.12",
                "--success": "142 71% 45%",
                "--warning": "38 92% 50%",
                "--danger": "0 72% 55%",
                "--danger-subtle": "0 72% 55% / 0.1",
                "--shadow-sm": "0 1px 2px hsl(0 0% 0% / 0.2), 0 1px 3px hsl(0 0% 0% / 0.15)",
                "--shadow-md": "0 4px 6px hsl(0 0% 0% / 0.2), 0 2px 4px hsl(0 0% 0% / 0.15)",
                "--shadow-lg": "0 10px 25px hsl(0 0% 0% / 0.3), 0 4px 10px hsl(0 0% 0% / 0.2)",
                "--shadow-glass": "0 8px 32px hsl(0 0% 0% / 0.25), inset 0 1px 0 hsl(0 0% 100% / 0.04)",
                "--blur-glass": "20px",
                "--blur-bg": "40px",
                "--noise-opacity": "0.03",
                "--scrollbar-track": "224 20% 12%",
                "--scrollbar-thumb": "224 15% 26%",
                "--code-bg": "224 20% 10%"
            }
        };

        function resolveTheme(mode) {
            if (mode === 'auto') {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            return mode;
        }

        function applyTheme(resolved) {
            document.documentElement.setAttribute('data-theme', resolved);
            const tokens = themes[resolved];
            if (tokens) {
                Object.entries(tokens).forEach(([k, v]) => {
                    document.documentElement.style.setProperty(k, v);
                });
            }
            // Update active button
            document.querySelectorAll('.theme-switcher-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const mode = localStorage.getItem('theme-preference') || 'auto';
            const activeBtn = document.querySelector(`[data-theme-mode="${mode}"]`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        function setThemeMode(mode) {
            localStorage.setItem('theme-preference', mode);
            applyTheme(resolveTheme(mode));
            // Update active state
            document.querySelectorAll('.theme-switcher-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.themeMode === mode);
            });
        }

        function initTheme() {
            let saved = localStorage.getItem('theme-preference') || 'auto';
            // Migrate legacy values
            if (saved === 'future' || saved === 'dark' || saved === 'system') saved = 'dark';
            if (saved === 'bare' || saved === 'light') saved = 'light';
            if (!['light', 'dark', 'auto'].includes(saved)) saved = 'auto';
            localStorage.setItem('theme-preference', saved);
            applyTheme(resolveTheme(saved));
            // Mark active button
            const activeBtn = document.querySelector(`[data-theme-mode="${saved}"]`);
            if (activeBtn) activeBtn.classList.add('active');
            // Listen for system preference changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const current = localStorage.getItem('theme-preference') || 'auto';
                if (current === 'auto') applyTheme(resolveTheme('auto'));
            });
        }

        initTheme();

        // Extract conversation ID from URL path
        const conversationId = window.location.pathname.split('/conversation/')[1];

        // Store conversation data globally for download functions
        let conversationData = null;

        async function loadConversation() {
            const div = document.getElementById('conversation');

            if (!conversationId) {
                div.innerHTML = `
                    <div class="header" style="border-left-color: hsl(var(--danger));">
                        <h2>Error</h2>
                    </div>
                    <div class="message" style="border-left-color: hsl(var(--danger));">
                        <div class="role">ERROR</div>
                        <div class="content">No conversation ID provided in URL</div>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/conversation/${conversationId}`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({detail: 'Unknown error'}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

                const data = await response.json();

                // Validate data
                if (!data || typeof data !== 'object') {
                    throw new Error('Invalid response data');
                }

                // Store for download functions
                conversationData = data;

                // Detect tool from file_path
                const tool = data.file_path.endsWith('.jsonl') ? 'claude' : 'vibe';
                const toolLabel = tool === 'claude' ? 'Claude Code' : 'Vibe';

                div.innerHTML = `
                    <div class="header">
                        <span class="tool-badge ${tool}">${toolLabel}</span>
                        <h2>${data.title || 'No title available'}</h2>
                        <div>Project: ${data.project_id || 'Unknown'} | Messages: ${data.message_count || 0}</div>
                        <div class="header-actions">
                            <button class="resume-btn" id="resumeBtn">Resume Session</button>
                            <button class="download-btn" id="downloadTxt">Download TXT</button>
                            <button class="download-btn" id="downloadHtml">Download HTML</button>
                        </div>
                    </div>
                `;

                // Add button handlers
                document.getElementById('resumeBtn').addEventListener('click', function() {
                    resumeSession(conversationId, this);
                });
                document.getElementById('downloadTxt').addEventListener('click', downloadAsTxt);
                document.getElementById('downloadHtml').addEventListener('click', downloadAsHtml);

                if (data.messages && Array.isArray(data.messages)) {
                    data.messages.forEach((msg, i) => {
                        const msgDiv = document.createElement('div');
                        msgDiv.className = `message ${msg.role || 'unknown'}`;
                        msgDiv.innerHTML = `
                            <div class="role">${(msg.role || 'unknown').toUpperCase()} - Message ${i + 1}</div>
                            <div class="content">${escapeHtml((msg.content || '').substring(0, 2000))}${(msg.content || '').length > 2000 ? '...[truncated]' : ''}</div>
                        `;
                        div.appendChild(msgDiv);
                    });
                } else {
                    div.innerHTML += '<div class="message">No messages available</div>';
                }
            } catch (error) {
                div.innerHTML = `
                    <div class="header" style="border-left-color: hsl(var(--danger));">
                        <h2>Error Loading Conversation</h2>
                    </div>
                    <div class="message" style="border-left-color: hsl(var(--danger));">
                        <div class="role">ERROR</div>
                        <div class="content">${escapeHtml(error.message)}</div>
                        <div class="content" style="margin-top: 10px; opacity: 0.7;">
                            Conversation ID: ${escapeHtml(conversationId)}
                        </div>
                    </div>
                `;
                console.error('Error loading conversation:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function resumeSession(convId, buttonElement) {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = 'Opening...';
            buttonElement.disabled = true;

            try {
                const response = await fetch('/api/resume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversation_id: convId })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    buttonElement.innerHTML = 'Opened in terminal';
                    buttonElement.classList.add('success');
                    setTimeout(() => {
                        buttonElement.innerHTML = originalText;
                        buttonElement.classList.remove('success');
                        buttonElement.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(data.detail || 'Failed to resume session');
                }
            } catch (error) {
                buttonElement.innerHTML = 'Failed - check console';
                buttonElement.classList.add('error');
                console.error('Resume error:', error);
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.classList.remove('error');
                    buttonElement.disabled = false;
                }, 3000);
            }
        }

        function downloadAsTxt() {
            if (!conversationData) return;

            const lines = [];
            lines.push(`Title: ${conversationData.title || 'Untitled'}`);
            lines.push(`Project: ${conversationData.project_id || 'Unknown'}`);
            lines.push(`Messages: ${conversationData.message_count || 0}`);
            lines.push(`Conversation ID: ${conversationId}`);
            lines.push('');
            lines.push('='.repeat(80));
            lines.push('');

            if (conversationData.messages) {
                conversationData.messages.forEach((msg, i) => {
                    const role = (msg.role || 'unknown').toUpperCase();
                    lines.push(`[${role}] Message ${i + 1}`);
                    lines.push('-'.repeat(40));
                    lines.push(msg.content || '');
                    lines.push('');
                });
            }

            const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation-${conversationId.slice(-8)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadAsHtml() {
            if (!conversationData) return;

            const messages = (conversationData.messages || []).map((msg, i) => {
                const role = (msg.role || 'unknown');
                const roleUpper = role.toUpperCase();
                const bgColor = role === 'user' ? '#e8f5e9' : '#e3f2fd';
                const borderColor = role === 'user' ? '#4caf50' : '#2196f3';
                const content = escapeHtml(msg.content || '').replace(/\n/g, '<br>');
                return `
                    <div style="background: ${bgColor}; border-left: 3px solid ${borderColor}; padding: 15px; margin: 15px 0; border-radius: 4px;">
                        <div style="font-weight: bold; margin-bottom: 10px; color: #333;">${roleUpper} - Message ${i + 1}</div>
                        <div style="white-space: pre-wrap; font-family: inherit;">${content}</div>
                    </div>
                `;
            }).join('');

            const html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${escapeHtml(conversationData.title || 'Conversation')}</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        h1 { color: #333; border-bottom: 2px solid #2196f3; padding-bottom: 10px; }
        .meta { color: #666; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>${escapeHtml(conversationData.title || 'Untitled Conversation')}</h1>
    <div class="meta">
        <strong>Project:</strong> ${escapeHtml(conversationData.project_id || 'Unknown')} |
        <strong>Messages:</strong> ${conversationData.message_count || 0} |
        <strong>ID:</strong> ${escapeHtml(conversationId)}
    </div>
    ${messages}
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation-${conversationId.slice(-8)}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        loadConversation();
    </script>
</body>
</html>
