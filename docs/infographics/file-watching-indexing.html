<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Searchat — File Watching & Live Indexing</title>
  <link rel="stylesheet" href="shared/navigation.css">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    /* Light Theme (default) */
    :root {
      --c-bg: #f6f8fa; --c-surface: #ffffff; --c-border: #d0d7de;
      --c-text: #24292f; --c-muted: #57606a;
      --c-event: #1B6AC9; --c-debounce: #D4740A; --c-queue: #8B3EC9;
      --c-index: #0E7C3A; --c-status: #9E6A00;
      --shadow-sm: 0 1px 3px rgba(28,33,39,0.08);
      --shadow-md: 0 3px 10px rgba(28,33,39,0.13);
      --r-sm: 3px; --r-md: 6px; --r-lg: 10px;
    }
    /* Dark Theme - System preference */
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme="light"]) {
        --c-bg: #0d1117; --c-surface: #161b22; --c-border: #30363d;
        --c-text: #c9d1d9; --c-muted: #8b949e;
        --c-event: #58a6ff; --c-debounce: #ffa657; --c-queue: #bc8cff;
        --c-index: #3fb950; --c-status: #d29922;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
        --shadow-md: 0 3px 10px rgba(0,0,0,0.4);
      }
    }
    /* Dark Theme - Manual override */
    :root[data-theme="dark"] {
      --c-bg: #0d1117; --c-surface: #161b22; --c-border: #30363d;
      --c-text: #c9d1d9; --c-muted: #8b949e;
      --c-event: #58a6ff; --c-debounce: #ffa657; --c-queue: #bc8cff;
      --c-index: #3fb950; --c-status: #d29922;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 3px 10px rgba(0,0,0,0.4);
    }
    /* Light Theme - Manual override */
    :root[data-theme="light"] {
      --c-bg: #f6f8fa; --c-surface: #ffffff; --c-border: #d0d7de;
      --c-text: #24292f; --c-muted: #57606a;
      --c-event: #1B6AC9; --c-debounce: #D4740A; --c-queue: #8B3EC9;
      --c-index: #0E7C3A; --c-status: #9E6A00;
      --shadow-sm: 0 1px 3px rgba(28,33,39,0.08);
      --shadow-md: 0 3px 10px rgba(28,33,39,0.13);
    }
    body {
      margin: 0; padding: 20px; background: var(--c-bg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      font-size: 13px; color: var(--c-text); line-height: 1.5;
    }
    .page { max-width: 900px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 2px solid var(--c-border); }
    .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
    .header .subtitle { font-size: 16px; color: var(--c-muted); margin-bottom: 12px; }
    .header .meta { font-family: 'SFMono-Regular', Consolas, monospace; font-size: 11px; color: var(--c-muted); }

    /* Timeline */
    .timeline { position: relative; padding-left: 60px; }
    .timeline::before {
      content: ''; position: absolute; left: 20px; top: 0; bottom: 80px;
      width: 4px; background: linear-gradient(to bottom, var(--c-event), var(--c-debounce), var(--c-queue), var(--c-index), var(--c-status));
    }
    .timeline-event {
      position: relative; margin-bottom: 24px; background: var(--c-surface);
      padding: 16px; border-radius: var(--r-md); box-shadow: var(--shadow-md);
      border-left: 4px solid var(--event-color);
    }
    .timeline-event::before {
      content: ''; position: absolute; left: -49px; top: 20px;
      width: 16px; height: 16px; border-radius: 50%;
      background: var(--event-color); border: 3px solid var(--c-bg);
    }
    .event-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .event-number {
      width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
      background: var(--event-color); color: white; border-radius: 50%; font-weight: 700; font-size: 12px;
    }
    .event-title { font-weight: 700; color: var(--event-color); font-size: 15px; }
    .event-desc { font-size: 12px; color: var(--c-muted); margin-bottom: 8px; }
    .event-detail {
      background: rgba(0,0,0,0.02); padding: 10px; border-radius: var(--r-sm);
      font-size: 12px; border-left: 3px solid var(--event-color);
    }
    .time-badge {
      display: inline-block; background: var(--event-color); color: white;
      padding: 3px 8px; border-radius: 999px; font-size: 10px; font-weight: 600; margin-left: 8px;
    }
    .kpi-bar {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;
      padding: 16px; background: var(--c-surface); border-radius: var(--r-md); box-shadow: var(--shadow-sm);
    }
    .kpi-item { text-align: center; padding: 10px; border-radius: var(--r-sm); background: rgba(0,0,0,0.02); }
    .kpi-value { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .kpi-label { font-size: 10px; color: var(--c-muted); text-transform: uppercase; }
    .footer {
      padding: 16px; background: var(--c-surface); border-radius: var(--r-md);
      box-shadow: var(--shadow-sm); font-size: 11px; color: var(--c-muted); line-height: 1.6;
    }
    .footer strong { color: var(--c-text); }
    /* Theme Toggle */
    .theme-toggle {
      position: fixed; top: 20px; right: 20px; display: flex; gap: 8px;
      background: var(--c-surface); border: 1px solid var(--c-border);
      border-radius: 6px; padding: 6px; box-shadow: var(--shadow-md); z-index: 1000;
    }
    .theme-toggle button {
      width: 36px; height: 36px; border: 1px solid transparent;
      border-radius: 4px; background: transparent; color: var(--c-muted);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease; padding: 0;
    }
    .theme-toggle button:hover { background: var(--c-bg); color: var(--c-text); }
    .theme-toggle button.active { background: var(--c-event); color: white; border-color: var(--c-event); }
    .theme-toggle button svg { width: 18px; height: 18px; }
  </style>
</head>
<body data-page="filewatching">
  <!-- Theme Toggle -->
  <div class="theme-toggle">
    <button data-theme="light" title="Light mode" aria-label="Light mode">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    </button>
    <button data-theme="dark" title="Dark mode" aria-label="Dark mode">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
    <button data-theme="system" title="System mode" aria-label="System mode">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
        <line x1="8" y1="21" x2="16" y2="21"></line>
        <line x1="12" y1="17" x2="12" y2="21"></line>
      </svg>
    </button>
  </div>
  <div class="page">
    <div class="header">
      <h1>Searchat — File Watching & Live Indexing</h1>
      <div class="subtitle">Event-Driven · Debounced · Queue-Based · Append-Only</div>
      <div class="meta">
        <strong>v0.4.0</strong> | Last updated: 2026-02-03<br>
        Python 3.9+ · watchdog · Queue · Background Thread
      </div>
    </div>

    <div class="timeline">
      <div class="timeline-event" style="--event-color: var(--c-event);">
        <div class="event-header">
          <div class="event-number">1</div>
          <div class="event-title">File System Event Detection</div>
        </div>
        <div class="event-desc">watchdog.Observer monitors conversation directories for file changes</div>
        <div class="event-detail">
          <strong>Monitored Events:</strong> Created, Modified<br>
          <strong>Watched Directories:</strong> ~/.claude/projects/, ~/.vibe/logs/, ~/.local/share/opencode/
        </div>
      </div>

      <div class="timeline-event" style="--event-color: var(--c-event);">
        <div class="event-header">
          <div class="event-number">2</div>
          <div class="event-title">Extension Check & Connector Detection</div>
        </div>
        <div class="event-desc">Identifies file type and selects appropriate connector</div>
        <div class="event-detail">
          <strong>Supported:</strong> .jsonl (Claude), .json (Vibe/OpenCode), .db (Cursor), .md (Aider)<br>
          <strong>Action:</strong> Unsupported extensions ignored
        </div>
      </div>

      <div class="timeline-event" style="--event-color: var(--c-debounce);">
        <div class="event-header">
          <div class="event-number">3</div>
          <div class="event-title">Debounce Gate<span class="time-badge">2s / 5min</span></div>
        </div>
        <div class="event-desc">Time-based delay prevents indexing in-progress files</div>
        <div class="event-detail">
          <strong>New Files:</strong> 2s delay (fast indexing for completed files)<br>
          <strong>Modified Files:</strong> 5min delay (prevents re-indexing during active editing)
        </div>
      </div>

      <div class="timeline-event" style="--event-color: var(--c-queue);">
        <div class="event-header">
          <div class="event-number">4</div>
          <div class="event-title">Queue Enqueue</div>
        </div>
        <div class="event-desc">Event added to pending updates queue</div>
        <div class="event-detail">
          <strong>Queue Type:</strong> Python Queue (thread-safe)<br>
          <strong>Batch Delay:</strong> 5s (groups multiple events)
        </div>
      </div>

      <div class="timeline-event" style="--event-color: var(--c-queue);">
        <div class="event-header">
          <div class="event-number">5</div>
          <div class="event-title">Background Thread Consumption</div>
        </div>
        <div class="event-desc">Separate thread processes queued events without blocking</div>
        <div class="event-detail">
          <strong>Method:</strong> _process_pending_updates()<br>
          <strong>Isolation:</strong> Indexing runs in background, UI remains responsive
        </div>
      </div>

      <div class="timeline-event" style="--event-color: var(--c-index);">
        <div class="event-header">
          <div class="event-number">6</div>
          <div class="event-title">Index Append Operation</div>
        </div>
        <div class="event-desc">Safe append-only indexing (never deletes existing data)</div>
        <div class="event-detail">
          <strong>Method:</strong> indexer.index_append_only(file_paths)<br>
          <strong>Safety:</strong> Only adds new conversations, preserves all existing data
        </div>
      </div>

      <div class="timeline-event" style="--event-color: var(--c-status);">
        <div class="event-header">
          <div class="event-number">7</div>
          <div class="event-title">Watcher Stats Update</div>
        </div>
        <div class="event-desc">Updates statistics: indexed_count, last_update, in_progress flag</div>
        <div class="event-detail">
          <strong>Tracked:</strong> Files indexed since start, timestamp of last update<br>
          <strong>API:</strong> GET /api/watcher/status
        </div>
      </div>

      <div class="timeline-event" style="--event-color: var(--c-status);">
        <div class="event-header">
          <div class="event-number">8</div>
          <div class="event-title">UI Refresh (Optional)</div>
        </div>
        <div class="event-desc">Web UI can poll for updated statistics and refresh results</div>
        <div class="event-detail">
          <strong>Polling:</strong> Optional real-time updates via periodic API calls<br>
          <strong>Auto-Discovery:</strong> New conversations appear in search automatically
        </div>
      </div>
    </div>

    <div class="kpi-bar">
      <div class="kpi-item">
        <div class="kpi-value">2s / 5min</div>
        <div class="kpi-label">Debounce Times</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value">5s</div>
        <div class="kpi-label">Batch Delay</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value">Queue</div>
        <div class="kpi-label">Thread-Safe</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-value">Append-Only</div>
        <div class="kpi-label">Safe Indexing</div>
      </div>
    </div>

    <div class="footer">
      <strong>Source Files:</strong><br>
      • <code>src/searchat/core/watcher.py</code> (ConversationWatcher + ConversationEventHandler, 323 LOC)<br>
      • <code>src/searchat/core/indexer.py</code> (index_append_only method)<br>
      • <code>src/searchat/core/connectors/base.py</code> (AgentConnector protocol)<br><br>
      <strong>Configuration:</strong> auto_index, reindex_on_modification, modification_debounce_minutes in settings.toml
    </div>
  </div>
  <script>
    // Theme Management - Synced with main UI
    function applyTheme(theme) {
      const root = document.documentElement;
      if (theme === 'system') {
        root.removeAttribute('data-theme');
      } else {
        root.setAttribute('data-theme', theme);
      }
    }
    function updateButtonStates(currentTheme) {
      document.querySelectorAll('.theme-toggle button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === currentTheme);
      });
    }
    function setTheme(theme) {
      localStorage.setItem('theme-preference', theme);
      applyTheme(theme);
      updateButtonStates(theme);
    }
    function initTheme() {
      const savedTheme = localStorage.getItem('theme-preference') || 'system';
      applyTheme(savedTheme);
      updateButtonStates(savedTheme);
    }
    initTheme();
    window.addEventListener('storage', (e) => {
      if (e.key === 'theme-preference' && e.newValue) {
        applyTheme(e.newValue);
        updateButtonStates(e.newValue);
      }
    });
    document.querySelectorAll('.theme-toggle button').forEach(btn => {
      btn.addEventListener('click', () => setTheme(btn.dataset.theme));
    });
  </script>
  <script src="shared/navigation.js"></script>
</body>
</html>
